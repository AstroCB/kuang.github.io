<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        #tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            font: 14px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }

        .states {
            fill: none;
            stroke: black;
            stroke-linejoin: round;
        }

        .been-to {
             fill: salmon;
        }
    </style>
</head>

<body>
    <script type="text/javascript">

        //Width and height of map
        const width = 1650;
        const height = 700;

        // D3 Projection
        const projection = d3.geoAlbersUsa()
            .translate([width / 2, height / 2])    // translate to center of screen
            .scale([1500]);          // scale things down so see entire US

        // Define path generator
        const path = d3.geoPath()     // path generator that will convert GeoJSON to SVG paths
            .projection(projection);  // tell path generator to use albersUsa projection


        const googleSheetsLink = "https://spreadsheets.google.com/feeds/list/1rp9DbKZ6S1XxXAisAy-MPLqzeLyECViiXDl00WouV2g/od6/public/values?alt=json";
        const usMap = "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json";
        let statesVisited = [];
        let schoolsVisited = [];
        let schoolsLocationMap = {};

        let googleMapsAPILink = 'https://maps.googleapis.com/maps/api/geocode/json?address=';

        // please don't steal my API key- too lazy to hide t
        let apiKey = '&key=AIzaSyDbNelFfAo3d0dhG82c6B4FsVy5ucW6zjI';

        async function schoolsToCoords(schoolStringList) {
            const promises = schoolStringList.map(individualSchoolToCoords);

            await Promise.all(promises).then(function (data) {
                for (let i = 0; i < data.length; i++) {
                    latLongObj = data[i].results[0].geometry.location;
                    const loc = [latLongObj.lng, latLongObj.lat];
                    schoolsVisited.push(loc);
                    schoolsLocationMap[latLongObj.lng + latLongObj.lat] = schoolStringList[i];
                }
            });
        }

        function individualSchoolToCoords(school) {
            const gmapsAPISearchString = googleMapsAPILink + school + apiKey;
            return d3.json(gmapsAPISearchString);
        }

        function getSchoolNameFromCoords(coords) {
            const hash = coords[0] + coords[1];
            return schoolsLocationMap[hash];
        }

        async function loadMap() {
            let mapData = await d3.json(usMap);
            let statesData = await d3.json(googleSheetsLink);
            let schoolsVisitedArray = [];

            // parse spreadsheet data to create array of all schools
            statesData.feed.entry.forEach(state => {
                statesVisited.push(state.gsx$state.$t);
                const schoolsvisitedString = state.gsx$schoolsvisited.$t;
                const schoolsVisitedInCurrState = schoolsvisitedString.length > 0 ? schoolsvisitedString.split(", ") : [];
                schoolsVisitedInCurrState.forEach(school => {
                    schoolsVisitedArray.push(school);
                });
            });
            await schoolsToCoords(schoolsVisitedArray);
            d3.select('body')
                .append('div')
                .attr('id', 'tooltip')

            let svg = d3.select("div#map")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            svg.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(mapData.features)
                .enter().append("path")
                .attr("d", path)
                .classed('been-to', function (d) {
                    return statesVisited.includes(d.properties.name)
                });
            svg.selectAll("circle")
                .data(schoolsVisited).enter()
                .append("circle")
                .attr("cx", function (d) { return projection(d)[0]; })
                .attr("cy", function (d) { return projection(d)[1]; })
                .attr("r", "3px")
                .attr("fill", "blue")
                .on('mouseover', function (d) {
                    d3.select('#tooltip').style('opacity', 1).text(getSchoolNameFromCoords(d))
                })
                .on('mousemove', function () {
                    d3.select('#tooltip')
                        .style('left', d3.event.pageX + 10 + 'px')
                        .style('top', d3.event.pageY + 10 + 'px')
                })
                .on('mouseout', function () {
                    d3.select('#tooltip').style('opacity', 0)
                });
        }

        loadMap();

    </script>
    <div id="map"></div>
</body>

</html>